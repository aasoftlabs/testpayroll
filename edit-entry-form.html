<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Inventory Entry Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .options-list {
            position: fixed;
            /* Changed from absolute */
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* Stronger shadow for floating element */
            z-index: 9999;
            /* Very high Z-index */
            display: none;
            width: auto;
            /* Will be set via JS */
        }

        .options-list.show {
            display: block;
        }

        .options-list li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }

        .options-list li:hover,
        .options-list li.highlighted {
            background-color: #f3f4f6;
            color: #111827;
        }
    </style>
</head>

<div class="w-full mx-auto bg-white pb-24">
    <form id="entryForm" class="p-3 sm:p-5">
        <div class="flex flex-col lg:flex-row gap-4 sm:gap-6 lg:gap-8">
            <!-- Left Side: Inputs Stack -->
            <div class="w-full lg:w-1/3 space-y-4 sm:space-y-6">
                <!-- Left Header -->
                <div>
                    <h2 class="text-lg sm:text-xl font-extrabold text-gray-900 tracking-tight">Log Entry</h2>
                    <p class="text-gray-400 text-xs mt-0.5">Manage your inventory flow.</p>
                </div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Entry
                        Type</label><select name="type" onchange="handleEntryTypeChange(this)"
                        class="mt-1 block w-full rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3.5 transition-all"
                        required>
                        <option value="">Select Type</option>
                        <option value="Send">Send</option>
                        <option value="Received">Received</option>
                    </select></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Date</label><input type="date"
                        name="date" id="dateField"
                        class="mt-1 block w-full rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3.5 transition-all"
                        required></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Challan
                        Reference</label><input type="text" name="challanNo"
                        class="mt-1 block w-full rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3.5 transition-all"
                        placeholder="CH-XXXX" required></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Destination/Source</label>
                    <input type="text" name="location" id="locationInput" list="locationList"
                        class="mt-1 block w-full rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3.5 transition-all"
                        placeholder="Select or Type Location" required>
                    <datalist id="locationList">
                        <!-- Options populated by JS -->
                    </datalist>
                </div>
            </div>
            <!-- Right Side: Itemized Table -->
            <div class="w-full lg:w-2/3">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3 sm:gap-0">
                    <h3 class="text-xs sm:text-sm font-bold text-gray-900 uppercase tracking-widest">Line Items</h3>
                    <div class="flex items-center space-x-2 sm:space-x-3"><button type="button" onclick="addRow()"
                            class="flex items-center text-[10px] sm:text-xs font-bold text-indigo-700 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 uppercase tracking-wider transition-colors px-2 sm:px-3 py-1.5 rounded-md shadow-sm"><svg
                                class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>New Item </button><button type="button" onclick="openSettings()"
                            class="text-gray-400 hover:text-gray-600 transition-colors focus:outline-none p-1 rounded-full hover:bg-gray-100"
                            title="Open Settings"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg></button></div>
                </div>
                <div class="border border-gray-100 rounded-xl overflow-x-auto">
                    <table class="w-full min-w-[500px] divide-y divide-gray-100" id="itemsTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-4 py-3 text-center text-[10px] font-black text-gray-400 uppercase w-16 rounded-tl-xl">
                                    # </th>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-gray-400 uppercase">
                                    Item Description</th>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-gray-400 uppercase w-32">
                                    Quantity</th>
                                <th
                                    class="px-4 py-3 text-center text-[10px] font-black text-gray-400 uppercase w-16 rounded-tr-xl">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="itemRows" class="bg-white">
                            <tr class="item-row group">
                                <td
                                    class="px-4 py-4 text-sm text-gray-400 font-bold text-center sno-cell border-b border-gray-100">
                                    1</td>
                                <td class="px-4 py-2 border-b border-gray-100 relative item-select-container">
                                    <!-- Initial Searchable Dropdown -->
                                </td>
                                <td class="px-4 py-2 border-b border-gray-100"><input type="number" name="qty" min="1"
                                        value="1" oninput="validateRowStock(this)"
                                        class="qty-input text-sm font-medium text-gray-700 border-none bg-transparent focus:ring-0 w-full p-4"
                                        placeholder="0" required>
                                    <div class="stock-info text-[10px] text-gray-400 px-4 pb-1 hidden"></div>
                                </td>
                                <td class="px-4 py-2 text-center border-b border-gray-100"><span
                                        class="text-[10px] font-bold text-gray-300 uppercase">Fixed</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Fixed Footer Actions -->
        <div
            class="fixed bottom-0 left-0 right-0 h-auto min-h-16 bg-white border-t border-gray-100 px-3 sm:px-6 lg:px-8 py-3 sm:py-0 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-0 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div id="loader" class="flex items-center space-x-2 text-indigo-600"><svg
                    class="animate-spin h-4 w-4 hidden" id="syncSpinner" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                    </circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg><span id="messageBox" class="hidden text-sm font-medium"></span></div>
            <div class="flex flex-wrap items-center gap-2 sm:space-x-4 sm:ml-auto w-full sm:w-auto justify-end"><span
                    class="text-xs sm:text-sm font-bold text-gray-500 uppercase tracking-wide sm:mr-2 w-full sm:w-auto">Total
                    Qty: <span id="totalQty" class="text-gray-900">0</span></span>
                <!-- Delete Entry (Red) -->
                <button type="button" onclick="handleDeleteEntry()"
                    class="px-4 sm:px-6 py-2 sm:py-2.5 text-xs sm:text-sm font-bold text-red-500 border border-red-200 bg-red-50 hover:text-red-700 hover:bg-red-50 transition-colors rounded-md flex-1 sm:flex-none">
                    Delete Entry
                </button>
                <!-- Cancel (Neutral) -->
                <button type="button" onclick="handleCancel()"
                    class="px-4 sm:px-6 py-2 sm:py-2.5 text-xs sm:text-sm font-bold text-gray-500 border border-gray-200 bg-white hover:text-gray-700 hover:bg-gray-50 transition-colors rounded-md flex-1 sm:flex-none">
                    Cancel
                </button>
                <!-- Save Draft --><button type="button" id="draftBtn" onclick="handleDraft()"
                    class="px-4 sm:px-6 py-2 sm:py-2.5 text-xs sm:text-sm font-bold text-indigo-600 border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 rounded-md transition-all disabled:opacity-50 flex-1 sm:flex-none">Save
                    as Draft</button>
                <!-- Submit --><button type="submit" id="submitBtn"
                    class="px-6 sm:px-8 py-2 sm:py-2.5 text-xs sm:text-sm font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 shadow-sm hover:shadow-md transition-all disabled:bg-gray-300 flex-1 sm:flex-none">Submit
                </button>
            </div>
        </div>
    </form>
</div>
<!-- Settings Modal (Inline) -->
<div id="settingsModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-4 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeSettings()"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen"
            aria-hidden="true">&#8203;
        </span>
        <!-- Modal Panel -->
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-4 sm:align-middle sm:max-w-3xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Settings & Data Lists</h3><button onclick="closeSettings()"
                                class="text-gray-400 hover:text-gray-500 focus:outline-none p-1 rounded-full hover:bg-gray-100 transition-colors"><svg
                                    class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg></button>
                        </div>
                        <div class="mt-4">
                            <!-- Tabs & Add Button -->
                            <div
                                class="border-b border-gray-200 flex justify-between items-center bg-gray-50 px-2 rounded-t-lg">
                                <nav class="-mb-px flex space-x-6" aria-label="Tabs"><button onclick="switchTab('item')"
                                        id="tab-item"
                                        class="border-indigo-500 text-indigo-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">Item
                                    </button><button onclick="switchTab('store')" id="tab-store"
                                        class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">Store
                                    </button><button onclick="switchTab('customer')" id="tab-customer"
                                        class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors">Customer
                                    </button></nav><button onclick="openInputModal('add')"
                                    class="text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded shadow-sm transition-colors">+Add
                                    New </button>
                            </div>
                            <!-- List Content -->
                            <div class="mt-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar" id="settingsContent">
                                <!-- Dynamic Content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                <!-- Footer empty or status -->
            </div>
        </div>
    </div>
</div>
<!-- Generic Input Modal (Add/Edit) -->
<div id="inputModal" class="hidden fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeInputModal()"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen"
            aria-hidden="true">&#8203;
        </span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="inputModalTitle">Edit Entry
                        </h3>
                        <div class="mt-4"><input type="text" id="modalInput"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3"
                                placeholder="Enter value..."></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button"
                    onclick="handleInputConfirm()"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save
                </button><button type="button" onclick="closeInputModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel
                </button></div>
        </div>
    </div>
</div>
<!-- Generic Confirm Modal (Delete/Warning) -->
<div id="confirmModal" class="hidden fixed inset-0 z-[70] overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeConfirmModal()"></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen"
            aria-hidden="true">&#8203;
        </span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div id="confirmIconContainer"
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <!-- Warning Icon -->
                        <div id="confirmIconSvgContainer">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmModalTitle">
                            Confirm Action</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="confirmMessage">Are you sure you want to
                                proceed? </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button"
                    onclick="handleConfirmYes()" id="confirmYesBtn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">Delete
                </button><button type="button" onclick="closeConfirmModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel
                </button></div>
        </div>
    </div>
</div>
<script>    let cachedSettings = {
        locations: [], items: [], stores: [], customers: [], itemList: [], stock: {}
    };
    let activeTab = 'item';

    // Confirm Modal State
    let confirmCallback = null;

    // Input Modal State
    let inputModalMode = 'add'; // 'add' or 'edit'
    let inputModalTargetValue = null; // Stores original value for edit

    // Edit Mode State
    let originalChallan = null;

    window.onload = function () {
        console.log("Window Onload Started");
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateField').value = today;

        // Hide Draft Button in Edit Mode (simplification)
        const draftBtn = document.getElementById('draftBtn');
        if (draftBtn) draftBtn.style.display = 'none';

        // Update Submit Button Text
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) submitBtn.textContent = "Update Entry";

        refreshDropdowns();

        // One-time static row init
        const firstContainer = document.querySelector('.item-select-container');
        if (firstContainer) {
            createSearchableDropdown(firstContainer, cachedSettings.items, "");
        }

        // --- Edit Mode Data Fetching ---
        var editRowIndex = null;
        try {
            var rawIndex = "<?= rowIndex ?>";
            console.log("Raw Row Index:", rawIndex);
            if (rawIndex && rawIndex !== "undefined") {
                editRowIndex = parseInt(rawIndex);
            }
        } catch (e) { console.log("No rowIndex or template error", e); }

        if (editRowIndex) {
            document.getElementById('loader').classList.remove('hidden');
            showStatus("Fetching data...", "bg-blue-50 text-blue-700");

            google.script.run.withSuccessHandler(function (data) {
                if (data) {
                    restoreForm(data);
                    showStatus("Entry loaded.", "bg-green-50 text-green-700");
                } else {
                    showStatus("Entry not found.", "bg-red-50 text-red-700");
                }
                document.getElementById('loader').classList.add('hidden');
            }).withFailureHandler(function (err) {
                showStatus("Error: " + err.message, "bg-red-50 text-red-800");
            }).getEntryDataByChallan(editRowIndex);
        }
    }

    function restoreForm(data) {
        if (!data) return;

        // Header fields
        if (data.type) {
            const el = document.querySelector('select[name="type"]');
            if (el) {
                el.value = data.type;
                handleEntryTypeChange(el);
            }
        }

        if (data.date) document.getElementById('dateField').value = data.date;
        if (data.challanNo) {
            document.querySelector('input[name="challanNo"]').value = data.challanNo;
            originalChallan = data.challanNo;
        }

        // Location (Input + Datalist)
        if (data.location || (data.foundLocations && data.foundLocations.length > 0)) {
            const locInput = document.getElementById('locationInput');
            let targetLoc = data.location ? String(data.location).trim() : "";

            // Fallback strategy
            if (!targetLoc && data.foundLocations && data.foundLocations.length > 0) {
                targetLoc = String(data.foundLocations[0]).trim();
            }
            if (locInput) locInput.value = targetLoc;
        }

        // Items
        const tbody = document.getElementById('itemRows');
        tbody.innerHTML = ''; // Clear default row

        let items = [];
        let qtys = [];

        // Handle object array from backend
        if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
                items.push(item.itemName);
                qtys.push(item.qty);
            });
        }

        if (items.length > 0) {
            items.forEach((item, idx) => {
                addRow(); // Adds a row to the end
                const rows = tbody.querySelectorAll('.item-row');
                const lastRow = rows[rows.length - 1];

                // Set Quantity
                const qtyInput = lastRow.querySelector('input[name="qty"]');
                if (qtyInput) qtyInput.value = qtys[idx] || 1;

                // Set Item - We need to re-init the dropdown with the value
                const container = lastRow.querySelector('.item-select-container');
                createSearchableDropdown(container, cachedSettings.items, item || "");
            });
            updateTotalQty();
        } else {
            addRow(); // Empty default if no items
        }
    }

    function handleEntryTypeChange(select) {
        const val = select.value;
        const inputs = document.querySelectorAll('#entryForm input, #entryForm select');

        inputs.forEach(input => {
            if (input.type === 'submit' || input.type === 'button') return;
            // Reset styles
            input.className = "mt-1 block w-full rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-3.5 transition-all text-gray-900";
        });

        if (val === 'Send') {
            select.classList.remove('bg-gray-50', 'border-gray-200');
            select.classList.add('bg-red-50', 'border-red-200', 'focus:border-red-500', 'focus:ring-red-500');
        } else if (val === 'Received') {
            select.classList.remove('bg-gray-50', 'border-gray-200');
            select.classList.add('bg-green-50', 'border-green-200', 'focus:border-green-500', 'focus:ring-green-500');
        }

        // Re-validate stock
        document.querySelectorAll('.qty-input').forEach(input => validateRowStock(input));
    }

    function updateTotalQty() {
        let total = 0;
        document.querySelectorAll('input[name="qty"]').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById('totalQty').textContent = total;
    }

    function validateRowStock(input) {
        updateTotalQty();

        const row = input.closest('tr');
        const stockDiv = row.querySelector('.stock-info');
        const itemNameInput = row.querySelector('input[name="itemName"]');
        const itemName = itemNameInput ? itemNameInput.value : "";
        const typeSelect = document.querySelector('select[name="type"]');
        const isSend = typeSelect && typeSelect.value === 'Send';

        if (!isSend || !itemName) {
            stockDiv.classList.add('hidden');
            input.classList.remove('text-red-600');
            return;
        }

        const available = cachedSettings.stock && cachedSettings.stock[itemName] !== undefined ? cachedSettings.stock[itemName] : 0;
        const currentQty = parseInt(input.value) || 0;

        stockDiv.textContent = `Available: ${available}`;
        stockDiv.classList.remove('hidden');

        if (currentQty > available) {
            stockDiv.className = 'stock-info text-[10px] px-4 pb-1 text-red-500 font-bold';
            input.classList.add('text-red-600');
        } else {
            stockDiv.className = 'stock-info text-[10px] px-4 pb-1 text-green-600';
            input.classList.remove('text-red-600');
        }
    }

    function refreshDropdowns() {
        google.script.run.withSuccessHandler(populateDropdowns).withFailureHandler(function () {
            showStatus("Failed to load lists", "bg-red-50 text-red-700");
        }).getDropdownData();
    }

    function populateDropdowns(data) {
        cachedSettings = data;

        // Populate Location Datalist
        const locList = document.getElementById('locationList');
        if (locList) {
            locList.innerHTML = '';
            data.locations.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc;
                locList.appendChild(opt);
            });
        }

        // If settings modal is open
        if (!document.getElementById('settingsModal').classList.contains('hidden')) {
            renderSettingsList();
        }
    }

    function showStatus(text, classes) {
        const msg = document.getElementById('messageBox');
        msg.className = `text-sm font-medium px-3 py-1 rounded inline-block ${classes}`;
        msg.textContent = text;
        msg.classList.remove('hidden');
        if (!text.toLowerCase().includes("fetching") && !text.toLowerCase().includes("updating")) {
            setTimeout(() => msg.classList.add("hidden"), 4000);
        }
    }

    // --- Submit Logic (Update) ---
    document.getElementById('entryForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');

        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = "Updating...";
        showStatus("Updating entry...", "bg-indigo-50 text-indigo-700");

        // Serialize Form
        const form = document.getElementById('entryForm');
        const formData = {};
        new FormData(form).forEach((value, key) => {
            if (!formData[key]) {
                formData[key] = value;
            } else {
                if (!Array.isArray(formData[key])) formData[key] = [formData[key]];
                formData[key].push(value);
            }
        });

        google.script.run.withSuccessHandler(function (response) {
            btn.disabled = false;
            btn.textContent = originalText;

            if (response.status === "success") {
                openConfirmModal("Success", response.message, function () {
                    google.script.host.close();
                }, "Close", "bg-green-600 hover:bg-green-700");

                // Hide Cancel button in modal for this success message
                const cancelBtn = document.querySelector('#confirmModal button[onclick="closeConfirmModal()"]');
                if (cancelBtn) cancelBtn.style.display = 'none';

            } else {
                showStatus(response.message, "bg-red-50 text-red-800");
            }
        }).withFailureHandler(function (err) {
            btn.disabled = false;
            btn.textContent = originalText;
            showStatus("Error: " + err.message, "bg-red-50 text-red-800");
        }).updateEntryData(originalChallan, formData);
    });

    // --- UI Helper Functions (Settings & Modal) - Copied largely from Entry Form but kept minimal where possible --

    function resetForm() {
        // Not really needed for Edit Mode as we close on success, but good fallback
        document.getElementById('entryForm').reset();
        document.getElementById('itemRows').innerHTML = '';
        addRow();
        updateTotalQty();
    }

    function handleCancel() {
        google.script.host.close();
    }

    // --- Settings Modal Logic (Simplified Copy) ---
    function openSettings() {
        document.getElementById('settingsModal').classList.remove('hidden');
        renderSettingsList();
    }
    function closeSettings() {
        document.getElementById('settingsModal').classList.add('hidden');
    }
    function switchTab(tab) {
        activeTab = tab;
        ['item', 'store', 'customer'].forEach(t => {
            const el = document.getElementById('tab-' + t);
            if (t === tab) el.className = "border-indigo-500 text-indigo-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors";
            else el.className = "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors";
        });
        renderSettingsList();
    }
    function renderSettingsList() {
        const container = document.getElementById('settingsContent');
        container.innerHTML = '';
        let listKey = activeTab === 'item' ? 'itemList' : (activeTab + 's');
        if (!cachedSettings[listKey]) listKey = 'items';
        const list = cachedSettings[listKey] || [];

        const ul = document.createElement('ul');
        ul.className = "divide-y divide-gray-200";
        list.forEach(val => {
            const safeVal = val.replace(/'/g, "\\' ");
            const li = document.createElement('li');
            li.className = "py-3 flex justify-between items-center group px-3 rounded hover:bg-gray-50 border-b border-gray-100 last:border-0";
            li.innerHTML = `<span class="text-sm text-gray-700 font-medium truncate flex-1 mr-4">${val}</span> <div class="flex items-center space-x-2"> <button onclick="deleteItem('${safeVal}')" class="text-red-500 hover:text-red-700 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button> </div>`;
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }
    function deleteItem(val) {
        if (confirm("Delete " + val + "?")) {
            google.script.run.withSuccessHandler(populateDropdowns).manageSetting('delete', activeTab, val, null);
        }
    }

    // --- Input Modal Logic (Settings Add/Edit) ---
    function openInputModal(mode, val = '') {
        // Using simple prompt for simplicity in Edit Form settings management to reduce code duplication
        const newVal = prompt(mode === 'add' ? "Enter new value:" : "Edit value:", val);
        if (newVal) {
            if (mode === 'add') google.script.run.withSuccessHandler(populateDropdowns).manageSetting('add', activeTab, newVal, null);
            else google.script.run.withSuccessHandler(populateDropdowns).manageSetting('edit', activeTab, val, newVal);
        }
    }

    // --- Searchable Dropdown Logic (Identical to Entry Form) ---
    function createSearchableDropdown(container, options, initialValue = "") {
        container.innerHTML = ` <input type="text" class="search-input w-full text-sm font-medium text-gray-700 border-none bg-transparent focus:ring-0 p-4"
                placeholder="Select Item" value="${initialValue}"
                oninput="filterOptions(this)" onfocus="showOptions(this)" autocomplete="off" > <input type="hidden" name="itemName" value="${initialValue}" > <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400" > <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" ></path></svg> </div> <ul class="options-list" ></ul> `;
        const list = container.querySelector('.options-list');
        renderOptions(list, options);
    }
    function renderOptions(listElement, options) {
        listElement.innerHTML = '';
        if (options.length === 0) {
            listElement.innerHTML = '<li class="text-gray-400 italic cursor-default">No matches found</li>';
            return;
        }
        options.forEach(opt => {
            const li = document.createElement('li');
            li.textContent = opt;
            li.onclick = function () { selectOption(this, opt); };
            listElement.appendChild(li);
        });
    }
    function filterOptions(input) {
        const filter = input.value.toLowerCase();
        const list = input.parentElement.querySelector('.options-list');
        const filtered = cachedSettings.items.filter(item => item.toLowerCase().includes(filter));
        renderOptions(list, filtered);
        list.classList.add('show');
    }
    function showOptions(input) {
        document.querySelectorAll('.options-list.show').forEach(el => el.classList.remove('show'));
        const list = input.parentElement.querySelector('.options-list');
        repositionDropdown(list, input);
        list.classList.add('show');
    }
    function selectOption(li, value) {
        const container = li.closest('.item-select-container');
        const input = container.querySelector('.search-input');
        const hiddenInfo = container.querySelector('input[name="itemName"]');
        input.value = value;
        hiddenInfo.value = value;
        li.closest('.options-list').classList.remove('show');

        // Trigger validation if row exists
        const row = container.closest('tr');
        if (row) {
            const qty = row.querySelector('.qty-input');
            if (qty) validateRowStock(qty);
        }
    }
    // Shared Utils
    const closeAllDropdowns = () => { document.querySelectorAll('.options-list.show').forEach(el => el.classList.remove('show')); };
    document.addEventListener('click', function (e) { if (!e.target.closest('.item-select-container')) closeAllDropdowns(); });
    window.addEventListener('resize', closeAllDropdowns);

    function addRow() {
        const tbody = document.getElementById('itemRows');
        const rowCount = tbody.getElementsByClassName('item-row').length + 1;
        const tr = document.createElement('tr');
        tr.className = 'item-row group';
        tr.innerHTML = ` <td class="px-4 py-4 text-sm text-gray-400 font-bold text-center sno-cell border-b border-gray-100">${rowCount}</td> <td class="px-4 py-2 border-b border-gray-100 relative item-select-container"></td> <td class="px-4 py-2 border-b border-gray-100"> <input type="number" name="qty" min="1" value="1" oninput="validateRowStock(this)" class="qty-input text-sm font-medium text-gray-700 border-none bg-transparent focus:ring-0 w-full p-4" placeholder="0" required> <div class="stock-info text-[10px] text-gray-400 px-4 pb-1 hidden"></div> </td> <td class="px-4 py-2 text-center border-b border-gray-100"> <button type="button" onclick="removeRow(this)" class="p-2 text-gray-300 hover:text-red-500 transition-colors"> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> </button> </td> `;
        tbody.appendChild(tr);
        createSearchableDropdown(tr.querySelector('.item-select-container'), cachedSettings.items, "");
        updateTotalQty();
    }
    function removeRow(btn) {
        if (document.querySelectorAll('.item-row').length > 1) {
            btn.closest('tr').remove();
            // Re-index
            document.querySelectorAll('.sno-cell').forEach((cell, idx) => cell.textContent = idx + 1);
            updateTotalQty();
        }
    }

    // Reposition logic
    function repositionDropdown(list, input) {
        if (!list || !input) return;
        const rect = input.getBoundingClientRect();
        list.style.top = rect.bottom + 'px';
        list.style.left = rect.left + 'px';
        list.style.width = rect.width + 'px';
    }

    // --- Confirm Modal Logic ---
    function openConfirmModal(title, msg, callback, actionText = 'Delete', actionClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500') {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = msg;

        const btn = document.getElementById('confirmYesBtn');
        btn.textContent = actionText;

        // Reset classes and apply new ones
        btn.className = `w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm ${actionClass}`;

        // Handle Icon Styling
        const iconContainer = document.getElementById('confirmIconContainer');
        const iconSvgContainer = document.getElementById('confirmIconSvgContainer');

        if (actionClass.includes('green')) {
            // Success Style
            iconContainer.className = "mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10";
            iconSvgContainer.innerHTML = `<svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>`;
        } else {
            // Default/Warning Style (Red)
            iconContainer.className = "mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10";
            iconSvgContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>`;
        }

        confirmCallback = callback;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmCallback = null;

        // Ensure Reset of Cancel button in case it was hidden
        const cancelBtn = document.querySelector('#confirmModal button[onclick="closeConfirmModal()"]');
        if (cancelBtn) cancelBtn.style.display = '';
    }


    function handleDeleteEntry() {
        if (!originalChallan) {
            showStatus("Error: No entry selected to delete", "bg-red-50 text-red-800");
            return;
        }

        openConfirmModal("Delete Entry",
            "Are you sure you want to PERMANENTLY delete this entry? This cannot be undone.",
            function () {
                const btn = document.querySelector('button[onclick="handleDeleteEntry()"]');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = "Deleting...";
                }
                showStatus("Deleting entry...", "bg-red-50 text-red-700");

                google.script.run.withSuccessHandler(function (response) {
                    if (response.status === "success") {
                        openConfirmModal("Success", response.message, function () {
                            google.script.host.close();
                        }, "Close", "bg-green-600 hover:bg-green-700");

                        // Hide Cancel button
                        const cancelBtn = document.querySelector('#confirmModal button[onclick="closeConfirmModal()"]');
                        if (cancelBtn) cancelBtn.style.display = 'none';

                    } else {
                        showStatus(response.message, "bg-red-50 text-red-800");
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = "Delete Entry";
                        }
                    }
                }).withFailureHandler(function (err) {
                    showStatus("Error: " + err.message, "bg-red-50 text-red-800");
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = "Delete Entry";
                    }
                }).deleteEntryByChallan(originalChallan);
            },
            "Delete Forever",
            "bg-red-600 hover:bg-red-700 focus:ring-red-500"
        );
    }

    function handleCancel() {
        google.script.host.close();
    }

    function handleConfirmYes() {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
    }

</script>
</body>

</html>